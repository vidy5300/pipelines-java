trigger:
  - main

variables:
  GITHUB_REPO: https://$(GITHUB_PAT)@github.com/vidy5300/pipelines-java.git

# --------------------------
# ðŸš§ Build Job â€“ Linux Only
# --------------------------
jobs:
  - job: Build
    displayName: "Build on Linux JDK 11"
    pool:
      vmImage: ubuntu-latest
    variables:
      jdkVersion: "1.11"
    steps:
      - script: |
          echo "Updating Git remote URL to include token..."
          git remote set-url origin $(GITHUB_REPO)
          git fetch --unshallow || true
        displayName: "Set GitHub remote with PAT"

      - task: Maven@4
        name: BuildStep
        inputs:
          mavenPomFile: "pom.xml"
          mavenOptions: "-Xmx3072m"
          javaHomeOption: "JDKVersion"
          jdkVersionOption: $(jdkVersion)
          jdkArchitectureOption: "x64"
          goals: "clean package"
        displayName: "Maven Build"

  # --------------------------
  # ðŸ§ª Test Job â€“ Matrix on Linux + Windows + JDKs
  # --------------------------
  - job: Test
    displayName: "Test Job"
    dependsOn: Build
    strategy:
      matrix:
        linux_jdk11:
          imageName: "ubuntu-latest"
          jdkVersion: "1.11"
        windows_jdk11:
          imageName: "windows-latest"
          jdkVersion: "1.11"
        linux_jdk17:
          imageName: "ubuntu-latest"
          jdkVersion: "1.17"
    maxParallel: 3
    pool:
      vmImage: $(imageName)

    steps:
      - task: Maven@4
        name: TestStep
        inputs:
          mavenPomFile: "pom.xml"
          mavenOptions: "-Xmx3072m"
          javaHomeOption: "JDKVersion"
          jdkVersionOption: $(jdkVersion)
          jdkArchitectureOption: "x64"
          publishJUnitResults: true
          testResultsFiles: "**/surefire-reports/TEST-*.xml"
          goals: "test"
        displayName: "Maven Test"

      - task: PublishCodeCoverageResults@1
        inputs:
          codeCoverageTool: "JaCoCo"
          summaryFileLocation: "target/site/jacoco/jacoco.xml"
          reportDirectory: "target/site/jacoco"
          failIfCoverageEmpty: true
